<html>
<head>
 	<title>GridEye RoadTest</title>
  	<link rel="stylesheet" href="jquery.onoff.css" media="screen">
  	<link rel="stylesheet" href="grideye.css" media="screen">
	<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
	<script src="jquery.onoff.js"></script>
	<script src="rainbow.js"></script>
</head>

<body>
    <hr>
      <span id="received"></span>
    <hr>
	<div class="container">
		<div class="grid-container">
			<div id="grid" style="float:left"></div>
			<div id="grid-bw" style="float:right"></div>
		</div>
		<div class="controls">
	        <h3>Non-latching relays:</h3>
			<div class="relay-label">Relay 1</div><div class="onoffswitch"> <input type="checkbox" class="onoffswitch-checkbox" id="nlr1"/ ></div>
			<div class="relay-label">Relay 2</div><div class="onoffswitch"> <input type="checkbox" class="onoffswitch-checkbox" id="nlr2"/ ></div>
			<div class="relay-label">Relay 3</div><div class="onoffswitch"> <input type="checkbox" class="onoffswitch-checkbox" id="nlr3"/ ></div>
			<div class="relay-label">Relay 4</div><div class="onoffswitch"> <input type="checkbox" class="onoffswitch-checkbox" id="nlr4"/ ></div>
			<div class="relay-label">Relay 5</div><div class="onoffswitch"> <input type="checkbox" class="onoffswitch-checkbox" id="nlr5"/ ></div>
			<div class="relay-label">Relay 6</div><div class="onoffswitch"> <input type="checkbox" class="onoffswitch-checkbox" id="nlr6"/ ></div>
			<div class="relay-label">Relay 7</div><div class="onoffswitch"> <input type="checkbox" class="onoffswitch-checkbox" id="nlr7"/ ></div>
			<div class="relay-label">Relay 8</div><div class="onoffswitch"> <input type="checkbox" class="onoffswitch-checkbox" id="nlr8"/ ></div>
			<h3>Latching relays:</h3>
			<div class="relay-label">Relay 1</div><div class="onoffswitch"> <input type="checkbox" class="onoffswitch-checkbox" id="lr1"/ ></div>
			<div class="relay-label">Relay 2</div><div class="onoffswitch"> <input type="checkbox" class="onoffswitch-checkbox" id="lr2"/ ></div>
			<div class="relay-label">Relay 3</div><div class="onoffswitch"> <input type="checkbox" class="onoffswitch-checkbox" id="lr3"/ ></div>
		</div>
		<div class="alarm-box">Alarm</div>
		<button class="reset-button">Reset Alarm</button>
		<button class="reload-button">Reload Background</button>
	</div>

<script>
$(document).ready(function() {
	var width=64;
    var height=64;
	var bw_width=8;
    var bw_height=8;
    $('input[type=checkbox]').onoff();
	for (var r=1;r<=height;r++) {
        var row = $('<div class="row"></div>');
        $('#grid').append(row);
        for (var i = 1; i <= width; i++) {
            var pixel = $('<div class="col"></div>').data('row', r).data('col', i);
            row.append(pixel);
        }
    }
	for (var r=1;r<=bw_height;r++) {
        var row_bw = $('<div class="row-bw"></div>');
		$('#grid-bw').append(row_bw);
		for (var i=1;i<=bw_width;i++) {
			var pixel_bw = $('<div class="col-bw"></div>').data('row-bw', r).data('col-bw', i);
			row_bw.append(pixel_bw);
			pixel_bw.on('click',null,{x:i,y:r}, function(ev) {
				$(this).toggleClass('active');
	            sendMessage({'data':JSON.stringify({'X':ev.data.x,'Y':ev.data.y})});
			});
		}
	}
});
var host = window.location.host;
var ws = new WebSocket('ws://'+host+'/ws');
var $message = $('#received');

ws.onopen = function(){
  $message.attr("class", 'label label-success');
  $message.text('Starting Up...');
};
ws.onmessage = function(ev){
  $message.attr("class", 'label label-info');
  //$message.text(ev.data);
  try{
      var json = JSON.parse(ev.data);
      if("ALARM" in json){
          var alarmBox=$(".alarm-box");
          if (json.ALARM=="SET"){
              alarmBox.addClass("blink")
          }
      }
      //var data=json.GE;
      if("NLR" in json) {
          var nlr = json.NLR;
          for (var i = 1; i <= 8; i++) {
              var checkBox = $("input[id=nlr" + i + "]");
              var value = ((nlr & (1 << (i - 1))) >> (i - 1)) == 1;
              checkBox.prop("checked", value);
          }
      }
      if("LR" in json) {
          var lr = json.LR;
          for (var i=1;i<=3;i++) {
              var checkBox = $("input[id=lr"+i+"]");
              var value=((lr&(1<<(i-1)))>>(i-1))==1
              checkBox.prop('checked', value);
          }
      }
      var tMax="GE_MAX" in json ? json.GE_MAX.toFixed(2) : "N/A";
      var tMin="GE_MIN" in json ? json.GE_MIN.toFixed(2) : "N/A";
      var tMean="GE_AVG" in json ? json.GE_AVG.toFixed(2) : "N/A";
      var tMdn="GE_MDN" in json ? json.GE_MDN.toFixed(2) : "N/A";
      var tStd="GE_STD" in json ? json.GE_STD.toFixed(2) : "N/A";
      $message.text("Max: "+tMax+"℃ - Min: "+tMin+"℃ - Mean: "+tMean+"℃ - Med: "+tMdn+"℃ - Std Dev: "+tStd+"℃");
      if ("GE" in json){
          var myRainbow = new Rainbow();
          myRainbow.setNumberRange(tMin*100,tMax*100);
          myRainbow.setSpectrum("#0000FF","#0800F6","#1000EE","#1800E6",
               "#2000DE","#2900D5", "#3100CD", "#3900C5",
               "#4100BD","#4A00B4","#5200AC","#5A00A4",
               "#62009C","#6A0094","#73008B","#7B0083",
               "#83007B","#8B0073","#94006A","#9C0062",
               "#A4005A","#AC0052","#B4004A","#BD0041",
               "#C50039","#CD0031","#D50029","#DE0020",
               "#E60018","#EE0010","#F60008","#FF0000");
          myRainbow.setSpectrum("#5e4fa2","#3288bd","#66c2a5","#abdda4","#e6f598","#ffffbf","#fee08b","#fdae61","#f46d43","#d53e4f","#9e0142");
          var rows = $('.row');
          for (var i=0;i<rows.length;i++){
              var row = rows[i];
              var cols = $('.col', row);
              for (var j=0; j<cols.length;j++){
                  $(cols[j]).css('background-color', myRainbow.colourAt(json.GE[i*cols.length+j]*100));
                  //$(cols[j]).text(json.GE[i*cols.length+j].toFixed(2)).css("fontSize",12).css("font-family","Verdana, Geneva, sans-serif");
              }
          }
      }
      if("GE_BINARY" in json) {
          var bw = json.GE_BINARY;
          var rows = $('.row-bw');
          for (var i = 0; i < rows.length; i++) {
              var row = rows[i];
              var cols = $('.col-bw', row);
              for (var j = 0; j < cols.length; j++) {
                  $(cols[j]).css('background-color', bw[i * cols.length + j]==1?"#FFFFFF" : "#000");
                  //$(cols[j]).text([i*cols.length+j].toFixed(2)).css("fontSize",12);
              }
          }
      }
  } catch(err){

  }
};
ws.onclose = function(ev){
  $message.attr("class", 'label label-important');
  $message.text('Sensor disconnected');
};
ws.onerror = function(ev){
  $message.attr("class", 'label label-warning');
  $message.text('error occurred');
};
var sendMessage = function(message) {
//console.log("sending:" + message.data);
ws.send(message.data);
};


// GUI Stuff


// send a command to the serial port
$('.reset-button').click(function(ev){
  	ev.preventDefault();
  	$(".alarm-box").removeClass("blink");
	sendMessage({'data':JSON.stringify({'ALARM':'RESET'})});
});

$('.reload-button').click(function(ev){
  	ev.preventDefault();
	sendMessage({'data':JSON.stringify({'BACKGROUND':'RESET'})});
});

for (var i=1;i<=8;i++) {
  $('input[id=nlr'+i+']').click({value:i},function(ev){
  	ev.preventDefault();
  	var statusStr=$(this).is(':checked')?'ON':'OFF';
	sendMessage({'data':JSON.stringify({'NLR':ev.data.value,'STATUS':statusStr})});
  });
}
for (var i=1;i<=3;i++) {
  $("input[id=lr"+i+"]").click({value:i},function(ev){
  	ev.preventDefault();
  	var statusStr=$(this).is(':checked')?'ON':'OFF';
	sendMessage({'data':JSON.stringify({'LR':ev.data.value,'STATUS': statusStr})});
  });
}
</script>

</body>
</html>
